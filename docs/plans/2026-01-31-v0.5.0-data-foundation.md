# OpenCode Free Fleet v0.5.0: Data Foundation Implementation Plan

## Overview

This plan implements **Phase 1 (v0.5.0): Data Foundation** of the OpenCode Free Fleet roadmap as defined in `docs/PRD.md`. The goal is to establish a robust intelligence layer with persistent caching, a rich cost taxonomy, and autonomous policy scraping.

This plan addresses:

- **FR-001**: Persistent Cache of Metadata
- **FR-002**: Cost Taxonomy (CONFIRMED_FREE, etc.)
- **FR-003**: Policy Scraping (Groq, OpenRouter)
- **FR-001 (Safety)**: Safety-First Design (Confidence Scores)

## Current State Analysis

- **MetadataOracle** (`src/core/oracle.ts`) uses an in-memory-only cache with a 1h TTL for `ModelsDevAdapter`.
- **MetricsEngine** (`src/core/metrics.ts`) handles its own file I/O to `~/.config/opencode/fleet-metrics.json`.
- **Cost Determination** is a simple boolean `isFree`, which is prone to false positives if provider policies change.
- **Scraping** is non-existent; the system relies on static whitelists and API pricing fields that might be outdated.

## Desired End State

A system where model metadata and provider policies are persisted to disk, categorized into distinct cost tiers, and periodically verified via automated scraping of pricing documentation.

### Key Discoveries:

- `src/core/oracle.ts:70`: `ModelMetadata` interface needs expansion.
- `src/core/metrics.ts:130`: `saveToDisk` contains logic that should be abstracted into a shared persistence utility.
- `src/core/scout.ts:266`: `fetchModelMetadata` is the central point for enrichment that needs to handle new tiers.

## What We're NOT Doing

- Implementing the **Fleet Intelligence Service (Daemon)** (Scheduled for Phase 3/v0.6.0).
- Implementing the **Central Intelligence Hub** (Scheduled for Phase 4/v1.0.0).
- Migration of existing metrics to the new cache directory (out of scope for data foundation).

## Implementation Approach

1.  **Shared Infrastructure**: Create `PersistenceManager` to centralize safe disk operations.
2.  **Schema Upgrade**: Define `CostTier` and `CostProfile` types.
3.  **Persistent Oracle**: Upgrade `MetadataOracle` to use disk-based caching at `~/.config/opencode/cache/metadata.json`.
4.  **Policy Scraper**: Implement `PolicyScraperOrchestrator` and initial scrapers for Groq/OpenRouter.
5.  **Strict Selection**: Update `Scout` to enforce high-confidence filtering in `ultra_free` mode.

---

## Phase 1: Shared Persistence Infrastructure

### Overview

Create a reusable utility for atomic JSON persistence and directory management to satisfy FR-001 and NFR-006.

### Changes Required:

#### 1. Persistence Manager

**File**: `src/core/persistence.ts`
**Changes**: Implement `PersistenceManager` class with `readJSON` and `writeJSON`.

```typescript
import * as fs from "fs";
import * as path from "path";

export class PersistenceManager {
  static ensureDir(dir: string): void {
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
    }
  }

  static writeJSON<T>(filePath: string, data: T): void {
    const dir = path.dirname(filePath);
    this.ensureDir(dir);
    // Atomic write: temp file then rename (simplified for now)
    fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
  }

  static readJSON<T>(filePath: string): T | null {
    if (!fs.existsSync(filePath)) return null;
    try {
      return JSON.parse(fs.readFileSync(filePath, "utf-8"));
    } catch {
      return null;
    }
  }
}
```

#### 2. MetricsEngine Refactor

**File**: `src/core/metrics.ts`
**Changes**: Use `PersistenceManager` instead of internal `fs` calls.

### Success Criteria:

#### Automated Verification:

- [x] Unit tests for `PersistenceManager` pass.
- [x] `MetricsEngine` still saves metrics correctly to `fleet-metrics.json`.

#### Manual Verification:

- [ ] Verify `~/.config/opencode/fleet-metrics.json` is updated after a request.

---

## Phase 2: Enhanced Metadata & Caching

### Overview

Upgrade the metadata taxonomy and implement disk-based caching in the Oracle (FR-001, FR-002).

### Changes Required:

#### 1. Taxonomy Types

**File**: `src/types/index.ts`
**Changes**: Add `CostTier` enum and update `ModelMetadata` / `FreeModel`.

```typescript
export type CostTier =
  | "CONFIRMED_FREE"
  | "FREEMIUM_LIMITED"
  | "UNKNOWN"
  | "CONFIRMED_PAID";

export interface ModelMetadata {
  // ... existing fields ...
  tier: CostTier;
  confidenceScore: number; // 0.0 - 1.0
  providerPolicyUrl?: string;
}
```

#### 2. Persistent Oracle Cache

**File**: `src/core/oracle.ts`
**Changes**:

- Initialize `MetadataOracle` by loading from `~/.config/opencode/cache/metadata.json`.
- Implement periodic disk sync in `ModelsDevAdapter`.
- Update `fetchModelMetadata` to use the new `CostTier` logic.

### Success Criteria:

#### Automated Verification:

- [x] `MetadataOracle` loads cached data on startup if offline.
- [x] Cache file `~/.config/opencode/cache/metadata.json` exists after first fetch.
- [x] `tsc` passes with new types.

---

## Phase 3: Policy Scraper Infrastructure

### Overview

Implement the architecture for automated discovery of provider pricing pages (FR-003).

### Changes Required:

#### 1. Scraper Orchestrator

**File**: `src/core/scraper.ts`
**Changes**: Implement `PolicyScraperOrchestrator` and `ProviderScraper` interface.

#### 2. Groq/OpenRouter Scrapers

**File**: `src/core/scrapers/groq.ts`, `src/core/scrapers/openrouter.ts`
**Changes**: Implement basic HTML/Markdown fetchers for pricing pages.

### Success Criteria:

#### Automated Verification:

- [x] `PolicyScraperOrchestrator.scrapeAll()` executes without crashing.
- [x] Policies are saved to `~/.config/opencode/cache/provider-policies.json`.

---

## Phase 4: Strict Ultra-Free Validation

### Overview

Enforce the "Safety-First" principle in the Scout discovery engine.

### Changes Required:

#### 1. Scout Filtering

**File**: `src/core/scout.ts`
**Changes**:

- In `ultra_free` mode, filter out any model where `tier !== 'CONFIRMED_FREE'` OR `confidenceScore < 0.9`.

### Success Criteria:

#### Automated Verification:

- [x] `Scout.discover()` returns only 100% confirmed free models when `ultraFreeMode` is true.

---

## Testing Strategy

### Unit Tests:

- Test `PersistenceManager` with mock filesystem.
- Test `MetadataOracle` tier resolution logic.

### Manual Testing Steps:

1. Delete `~/.config/opencode/cache/metadata.json`.
2. Run `/fleet-scout`.
3. Verify the cache file is created with `tier` fields.
4. Enable `ultra_free` mode and verify `/fleet-status` shows only high-confidence models.

## Performance Considerations

- Caching metadata reduces startup time from ~2s (API fetch) to <100ms (Disk read).
- Scraping should run in the background (fire-and-forget) to avoid blocking the main thread.

## References

- PRD: `docs/PRD.md` (Sections 3.2.1, 3.2.2, 5.1)
- Current Metrics: `src/core/metrics.ts`
- Current Oracle: `src/core/oracle.ts`
